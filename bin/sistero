#!/usr/bin/env ruby

require 'bundler/setup'
require 'sistero'
require 'optparse-subcommand'

module Sistero::Command
  def self.run args
    config = nil

    SubcommandOptionParser.new do |op|
      op.banner = 'usage: sistero [global options] command [command options]'

      op.for_all do |op|
        op.on_tail '-h', '--help', 'show this help message' do
          puts op
          exit
        end
      end

      op.on '-c', '--config file', 'override path to config file', 'cfg_file_path'

      op.subcommand 'ssh', 'ssh to vm' do |subop|
        subop.on '-o val', 'add ssh options', 'ssh_options'
      end

      op.subcommand 'create', 'create vm'
      op.subcommand 'destroy', 'destroy vm'
      op.subcommand 'list', 'list vms'
      op.subcommand 'show-config', 'show configuration'
      op.subcommand 'ssh-keys', 'show ssh keys'
      op.subcommand 'sizes', 'show possible sizes'
      op.subcommand 'regions', 'show possible regions'
      op.subcommand 'images', 'show images'

      parsed_cfg = op.parse args

      parsed_cfg.merge! parsed_cfg[:config]
      parsed_cfg.delete :config

      config = OpenStruct.new parsed_cfg
    end

    unless config.cmd
      puts 'please supply a command, see --help'
      exit
    end

    sistero = Sistero::Instance.new({ cfg_file_path: config.cfg_file_path })
    case config.cmd
    when 'ssh'
      vm_name, *ssh_args = config.args
      # TODO: pass ssh_args
      sistero.ssh_to_vm(vm_name, ssh_options: config.ssh_options)
    when 'create'
      vms = config.args.empty? ? [nil] : config.args
      vms.each { |vm_name| sistero.create_vm(vm_name) }
    when 'destroy'
      vms = config.args.empty? ? [nil] : config.args
      vms.each { |vm_name| sistero.destroy_vm(vm_name) }
    when 'list'
      sistero.list_vms()
    when 'show-config'
      sistero.show_config()
    when 'ssh-keys'
      sistero.show_ssh_keys()
    when 'sizes'
      sistero.show_sizes()
    when 'regions'
      sistero.show_regions()
    when 'images'
      sistero.show_images()
    end
  rescue RuntimeError => e
    puts e.to_s
  end
end

Sistero::Command::run ARGV
